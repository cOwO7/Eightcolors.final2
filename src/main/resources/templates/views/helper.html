<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/main_layout}">
<head>
<link href="bootstrap/bootstrap.min.css" rel="stylesheet">
<meta charset="UTF-8">
<title>고객센터</title>
<body>
  <th:block layout:fragment="content">
    <div class="container">
      <!-- FAQ Form -->
      <div class="accordion mb-5" id="faqAccordion">
        <br/><br/>
        <h3 class="mb-3">자주 묻는 질문 (FAQ)</h3>
        <div class="accordion-item">
          <h2 class="accordion-header" id="faq1Header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1" aria-expanded="false" aria-controls="faq1">
              Q1: 회원가입은 어떻게 하나요?
            </button>
          </h2>
          <div id="faq1" class="accordion-collapse collapse" aria-labelledby="faq1Header" data-bs-parent="#faqAccordion">
            <div class="accordion-body">
              회원가입은 홈페이지 상단의 '회원가입' 버튼을 클릭하시면 간단히 진행할 수 있습니다.
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="faq2Header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2" aria-expanded="false" aria-controls="faq2">
              Q2: 비밀번호를 잊어버렸습니다.
            </button>
          </h2>
          <div id="faq2" class="accordion-collapse collapse" aria-labelledby="faq2Header" data-bs-parent="#faqAccordion">
            <div class="accordion-body">
              로그인 페이지의 '비밀번호 찾기'를 통해 비밀번호를 재설정할 수 있습니다.
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="faq3Header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3" aria-expanded="false" aria-controls="faq3">
              Q3: 환불 정책이 어떻게 되나요?
            </button>
          </h2>
          <div id="faq3" class="accordion-collapse collapse" aria-labelledby="faq3Header" data-bs-parent="#faqAccordion">
            <div class="accordion-body">
              구매하신 숙박권(티켓)의 사용일자 <br />
              7일전 : 결제 금액 전액 환불   ※ 카드 결제시 : 결제 취소 ※ <br />
              5일전 : 결제 금액 60% 환불   ※ 카드 결제시 : 문의로 기재하신 계좌로 결재 금액 50% 환불※ <br />
              3일전 : 결제 금액 40% 환불   ※ 카드 결제시 : 문의로 기재하신 계좌로 결재 금액 30% 환불※ <br />
              1일전 : 결제 금액 20% 환불   ※ 카드 결제시 : 문의로 기재하신 계좌로 결재 금액 10% 환불※ <br />
              0일전 : 결제 금액 0.99% 환불 ※ 카드 결제시 : 문의로 기재하신 계좌로 결재 금액 0.99% 환불※ <br />
            </div>
          </div>
        </div>
      </div>

      <div class="mb-5">
        <h3 class="mb-3">문의하기</h3>
        <!-- 검색 폼 -->
        <form id="searchForm" class="mb-3">
          <div class="input-group row g-2 align-content-center">
            <div class="col-md-3">
            <select id="searchType" class="form-select flex-grow-2" aria-label="검색 옵션">
              <option value="all" selected>제목 & 내용</option>
              <option value="author">작성자</option>
            </select>
            </div>
            <div class="col-md-8">
            <input type="text" id="searchKeyword" class="form-control flex-grow-8" placeholder="검색어를 입력하세요">
            </div>
            <div class="col-md-1 text-end">
            <button class="btn btn-primary" type="button" id="searchBtn">검색</button>
            </div>
          </div>
        </form>

        <!-- 여기는 inpuiryBoardList -->
        <table class="table table-bordered">
          <thead>
          <tr>
            <th scope="col">번호</th>
            <th scope="col">제목</th>
            <th scope="col">상태</th>
            <th scope="col">작성자</th>
            <th scope="col">작성일</th>
          </tr>
          </thead>
          <tbody id="inquiryBoardList">
          <tr th:block th:each="inquiry : ${inquiryBList}">
            <!-- 문의글 출력 -->
            <td th:text="${inquiry.inquiryNo}"></td>
            <td th:href="@{inquiryDetail(no=${inquiry.inquiryNo})}" th:text="${inquiry.title}"></td>
            <td th:text="${inquiry.status}"></td>
            <td th:text="${inquiry.userName}"></td> <!-- 작성자 수정 -->
            <td th:text="${#dates.format(inquiry.inquiryDate, 'yyyy-MM-dd')}"></td>
          </tr>

          <!-- 답글이 있을 경우 답글을 표시 -->
          <tr th:block th:each="answer : ${inquiry.answers}">
            <td colspan="5">
              <!-- 답글 제목 표시 -->
              <strong>답변:</strong>
              <a th:href="@{answerDetail(no=${answer.answerNo})}" th:text="${answer.content}"></a><br />
              <span th:text="'작성자: ' + ${answer.adminName}"></span><br />
              <span th:text="'작성일: ' + ${#dates.format(answer.answerDate, 'yyyy-MM-dd')}"></span>
            </td>
          </tr>
          </tbody>
        </table>

        <!-- 페이징 버튼 -->
        <nav aria-label="Page navigation">
          <ul class="pagination" id="pagination">
            <!-- JavaScript로 페이지 추가 -->
          </ul>
        </nav>
        <!-- 문의 등록 버튼 -->
        <button class="btn btn-primary mt-3 text-end" id="createInquiryBtn">문의 등록</button>

        <!-- 문의 작성 폼 (숨김 처리) -->
        <div id="inquiryFormContainer" style="display: none; margin-top: 20px;">
          <form id="inquiryForm">
            <div class="mb-3">
              <label for="name" class="form-label">이름</label>
              <input type="text" class="form-control" id="name" name="name" placeholder="이름을 입력하세요" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">이메일</label>
              <input type="email" class="form-control" id="email" name="email" placeholder="답변받으실 이메일 주소를 입력하세요" required>
            </div>
            <div class="mb-3">
              <label for="accountNum" class="form-label">환불 계좌번호</label>
              <input type="text" class="form-control" id="accountNum" name="accountNum" placeholder="환불 받으실 계좌번호를 입력해주세요." required>
            </div>
            <div class="mb-3">
              <label for="message" class="form-label">문의 내용</label>
              <textarea class="form-control" id="message" name="message" rows="4" placeholder="문의 내용을 작성하세요" required></textarea>
            </div>
            <button type="button" class="btn btn-primary text-end" id="submitInquiry">문의 등록</button>
            <button type="button" class="btn btn-secondary" id="cancelInquiry">취소</button>
          </form>
        </div>
      </div>
      </div>

    <script>
      // 문의 작성 폼 토글
      document.getElementById("createInquiryBtn").addEventListener("click", function () {
        document.getElementById("inquiryFormContainer").style.display = "block";
      });

      document.getElementById("cancelInquiry").addEventListener("click", function () {
        document.getElementById("inquiryFormContainer").style.display = "none";
        document.getElementById("inquiryForm").reset();
      });

      // 문의 등록 요청
      document.getElementById("submitInquiry").addEventListener("click", function () {
        const formData = {
          name: document.getElementById("name").value,
          email: document.getElementById("email").value,
          accountNum: document.getElementById("accountNum").value,
          message: document.getElementById("message").value,
        };

        fetch("/inquiries", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        })
                .then((response) => {
                  if (!response.ok) {
                    return response.text().then((text) => {
                      throw new Error(text);
                    });
                  }
                  return response.json();
                })
                .then((data) => {
                  alert("문의가 성공적으로 등록되었습니다.");
                  document.getElementById("inquiryFormContainer").style.display = "none";
                  document.getElementById("inquiryForm").reset();
                  loadInquiries(); // 목록 새로고침
                })
                .catch((error) => {
                  console.error("문의 등록 중 오류 발생:", error);
                  alert("문의 등록 중 오류가 발생했습니다. 다시 시도해주세요.");
                });
      });

      // 문의 목록 불러오기
      function loadInquiries() {
        fetch("/inquiries")
                .then((response) => response.json())
                .then((data) => {
                  const tbody = document.getElementById("inquiryBoardList");
                  tbody.innerHTML = ""; // 기존 목록 초기화
                  data.forEach((inquiry, index) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
            <td>${index + 1}</td>
            <td>${inquiry.title}</td>
            <td>${inquiry.status === "answered" ? "답변 완료" : "대기 중"}</td>
            <td>${inquiry.name}</td>
            <td>${new Date(inquiry.inquiryDate).toLocaleString()}</td>
          `;
                    tbody.appendChild(row);
                  });
                });
      }

      // 초기 데이터 로드
      document.addEventListener("DOMContentLoaded", loadInquiries);
    </script>

    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </th:block>
</body>
</html>
